<!doctype html>

<html>
<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=9" />
	<link rel="stylesheet" type="text/css" href="http://js.arcgis.com/3.8/js/dojo/dijit/themes/claro/claro.css" />
	<link rel="stylesheet" href="http://js.arcgis.com/3.8/js/esri/css/esri.css" />
	<link rel="stylesheet" type="text/css" href="./POD.css" />
	<link id="ppstyle" rel="stylesheet" type="text/css" href="./style.css">
	<script>
		var dojoConfig = {
			async : true,
			//baseUrl: "/js/",
			tlmSiblingOfDojo : false,
			isDebug : 0,
			packages : [{
				name : "js",
				location : "/../js"
			}]
			};
	</script>
	<script type="text/javascript" src="http://js.arcgis.com/3.8/"></script>
	<script src="./ext.js"></script>
	<script src="./lib/CSInterface-4.0.0.js"></script>
	<script type="text/javascript">
		require(["dojo/parser",
        "dojo/ready", 
        "dojo/dom", 
        "dojo/dom-construct", 
        "dojo/_base/array", 
        "dijit/registry", 
        "dojo/on", 
        "esri/arcgis/Portal",
        "esri/arcgis/utils",
        "esri/request",
        "esri/SpatialReference",
        "esri/geometry/Extent",
        "esri/geometry/Point",
        "esri/tasks/ProjectParameters",
        "esri/tasks/GeometryService",
        "esri/config",
        "esri/lang",
        "dgrid/Grid", 
		"dijit/layout/BorderContainer",
		"dijit/layout/StackContainer",
		"dijit/layout/ContentPane",
		"dijit/form/TextBox",
		"dojo/domReady!"], function(parser,
        ready, 
        dom, 
        domConstruct, 
        array, 
        registry, 
        on, 
        esriPortal,
        arcgisUtils,
        esriRequest,
        SpatialReference,
        Extent,
        Point,
        ProjectParameters,
        GeometryService,
        config, 
        esriLang,
        Grid
		) {
        var portal, portalUrl, groupGrid, lastStyle, mapInfo, geoService;

        //Replaces dojo.ready / dojo.addOnLoad
        ready(function() {
			// Explicitly parse the page first
			parser.parse();
			// now configure the dijits and tasks
			esri.config.defaults.io.proxyUrl = "proxy/proxy.ashx";
			portalUrl = 'http://www.arcgis.com';
			
			// URL of Geometry Service
			geoService = new GeometryService('http://sampleserver6.arcgisonline.com/arcgis/rest/services/Utilities/Geometry/GeometryServer'); 
			//create the portal
			on(geoService, 'project-complete', onGeoFinish);
			on(geoService, 'error', onGeoError);
			
			portal = new esriPortal.Portal(portalUrl);
			
			on(portal, 'ready', function(p) {
			    dom.byId('findResults').disabled = false;
				on(dom.byId('findResults'), 'click', findFeatureServices);

			});						
		});
        
		function onGeoFinish(event)
		{
			console.log("Finish");
			
			// Define layer in service always 0. Sould be discussed 
			mapInfo += '/0';
			
			// Create map options for export web map tool (just extent)
			var mapOpts = {};
			mapOpts.extent = event.geometries[0].toJson();
			
			// Defining a layer with feature service to be exported
			var layer = {};
			layer.url = mapInfo;
			layer.title = "qqq"; // Any tittle
			var layers = [];
			layers.push(layer);
			
			// Base map. Just a base it will not be exported
			
			// Base map layer. We use a world map
			var bLayer = {};
			bLayer.id = "defaultBasemap";
			bLayer.opacity = "1";
			bLayer.visibility = "false";
			bLayer.url = "http://services.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer";
			var bLayers = [];
			bLayers.push(bLayer);
			
			// Base map itself
			var bMap = {};
			bMap.baseMapLayers = bLayers;
			bMap.title = "Topographic";
			
			// Export options. I chose these just from example
			var prOpt = {};
			var outSize = [];
			outSize.push("1280");
			outSize.push("1024");
			prOpt.dpi = "300";
			prOpt.outputSize = outSize;
			
			// The full web map to be exported
			var map = {};
			map.mapOptions = mapOpts;
			map.operationalLayers = layers;
			map.baseMap = bMap;
			map.exportOptions = prOpt;
			var strMap =  JSON.stringify(map);
			
			// REST request to GP tool for exporting web maps
			var ppp = 'http://sampleserver6.arcgisonline.com/arcgis/rest/services/Utilities/PrintingTools/GPServer/Export%20Web%20Map%20Task/execute?Web_Map_as_JSON=';
			ppp += strMap;
			ppp += '&Format=pdf&Layout_Template=&outSR=&processSR=&returnZ=false&returnM=false&f=pjson';
			console.log(ppp);
			var pdfRequest = esriRequest({
				url: ppp,
				handleAs: "json",
				callbackParamName: "callback"
			});
			pdfRequest.then(
				function(response) {
					
					// success request
					 console.log(response);
					 var param = response.results[0].value.url;
					 dowloadPdf(response.results[0].value.url);
				}, function(error) {
					alert("Could not export feature service");
			});
		}
		
		// 
		function onGeoError(event)
		{
			alert("Could not project feature service extent");
		}
        
		function onMouseOver(event)
		{
			dom.byId(event.target).style.backgroundColor='yellow';
		}
		function onMouseOut(event)
		{
			dom.byId(event.target).style.backgroundColor=lastStyle;
		}
		
		function onDouble(event)
		{
			// we have chosen a feature service to export
			// Now let's define the extent of feature service in base map spatial reference
			
			// get URL of featire service
			mapInfo = dom.byId(event.target).getAttribute('path');
			console.log(mapInfo);
			
			// Get its spatial reference
			var sr = dom.byId(event.target).getAttribute('sr');
			
			// check if it is a WKID
			var iii = parseInt(sr);
			if ((!iii) || (iii < 0))
			{
				
				// If it's not convert it to WKID. Here just 6 codes
				if (sr == "WGS_1984_Web_Mercator_Auxiliary_Sphere")
					iii = 102100;
				else if (sr == "Belge_Lambert_1972")
					iii = 31370;
				else if (sr == "GCS_North_American_1983")
					iii = 4269;
				else if (sr == "GCS_WGS_1984")
					iii = 4326;
				else if (sr == "SWEREF99_13_30")
					iii = 3008;
				else if (sr == "ETRS_1989_UTM_Zone_32N")
					iii = 25832;
				else
				{
					alert("Unknown code of spatial reference: " + sr);
					return
				}
			}
			
			// Spatial reference for feature service
			var mySr = new SpatialReference(iii);
			
			// Spatial reference for base map. Now it's hard coded
			var mapSr = new SpatialReference(102100);
			var eq = mapSr.equals(mySr); // just test. it alwys says "false"
			
			// Get extent from attributes of chosen <div>
			var ext = dom.byId(event.target).getAttribute('ext');
			var coors = ext.split(",")
			var minX = parseFloat(coors[0]);
			var minY = parseFloat(coors[1]);
			var maxX = parseFloat(coors[2]);
			var maxY = parseFloat(coors[3]);
			var myExt = new Extent(minX, minY, maxX, maxY, mySr);
			
			// Fill parameters for extent projecting
			var gms = [];
			gms.push(myExt);
			var pm = new ProjectParameters();
			pm.geometries = gms;
			pm.outSR = mapSr;
			
			// Go to project extent
			geoService.project(pm);
			
		}
				
        // find groups based on input keyword
        function findFeatureServices() {
        	
        	// The URL of search service. I tried to use appropriate object from ArcGIS for JavaScript. But this son of a bitch does not wanna sort by relevance  
        	var path = 'http://www.arcgis.com/sharing/rest/search?q=';
          	var keyword = dom.byId('searchText').value;
         	 path += keyword;
		  	path += '+type:%22feature%20service%22&f=pjson';
		  	
		  	// Let's go to search
		  	var layersRequest = esriRequest({
		  	url: path,
		  	handleAs: "json",
		  	callbackParamName: "callback"
		  });
		  layersRequest.then(
		  	 function(response) {
		  		showResults(response);
		  	 }, function(error) {
		  	 	 alert("Search request faild");
		  });
		  
        }

        //display a list of feature services that match the input pattern
        function showResults(response) {
          //clear any existing results
          	domConstruct.empty(dom.byId('results'));
            if (response.total > 0) {
            	for (var i=0; i < response.results.length; i++)
            	{
            		var strId ="row" + i; // Just ID of <div> corresponding a found feature service
            		
            		var sr = response.results[i].spatialReference;
            		if (!sr) // Id spatial reference is undefined set it to Web Mercator WGS 1984 - maybe it's wrong
            			sr = "WGS_1984_Web_Mercator_Auxiliary_Sphere";
            		
            		// Add URL of feature service, extent and SR to attributes of <div> 
            		var curRow = domConstruct.create('div', {id:strId, path:response.results[i].url, sr:response.results[i].spatialReference,ext:response.results[i].extent},dom.byId('results'));
            		
            		// thumb is the URL of a raster imge with preview
            		var thumb = 'http://www.arcgis.com/sharing/rest/content/items/'+ response.results[i].id+'/info/' + response.results[i].thumbnail; 
            		domConstruct.create('img',  { src: thumb }, curRow);
            		
            		// Add <span> with title of found feature service 
            		domConstruct.create('span',  {innerHTML: response.results[i].title}, curRow);
            		lastStyle = curRow.style.backgroundColor;
            		on(curRow, 'mouseover', onMouseOver);
            		on(curRow, 'mouseout', onMouseOut);
            		on(curRow, 'dblclick', onDouble);
            	}
            } else {
            	// Just report about empty search result
              dom.byId('results').innerHTML = '<h2>Group Results</h2><p>No groups were found. If the group is not public use the sign-in link to sign in and find private groups.</p>';
            }
        }

	});
	</script>

	<title>JsArcGisExtensionPrototype</title>
</head>

<body class="claro" onLoad="onLoaded()">
	<div id="content">
		<div class="container" id="header">
			<div class="searchPane">
				<span class="searchCtrl" > <!-- IE7: workaround for inherited margin bug: http://positioniseverything.net/explorer/inherited_margin.html -->
					<input type="text" class="text" id="searchText" tabindex="1"/>
				</span>
				<input type="submit" title="Start searching" name="submit" value="Search" class="search-button" disabled='disabled' id="findResults" tabindex="2"/>
			</div>
			<div class="logo">
				<img id="logoImg" src="./images/esri-logo.png"/>
			</div>
			
		</div>
		<div class="headerShadow"></div>
	      <div id='results' class="wide" style="text-align:left;" data-dojo-type="dijit/layout/ContentPane" data-dojo-props="region:'center'">
	      </div>
	</div>
</body>

</html>
